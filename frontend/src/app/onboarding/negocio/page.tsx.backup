'use client';
export const dynamic = 'force-dynamic';
import { useForm } from 'react-hook-form';
import { useSupabase } from "@/lib/supabase/client";


type ProducerFormData = {
  business_name: string;
  address: string;
  email: string;
  phone: string;
  description?: string | null;
  logo?: File | null;
};

export default function NegocioPage() {
  const supabase = useSupabase(); // ✅ instancia única estable
  const { register, handleSubmit, setValue } = useForm<ProducerFormData>({
    defaultValues: {
      business_name: '',
      address: '',
      email: '',
      phone: '',
      description: null,
      logo: null,
    },
  });

  const uploadLogo = async (file: File, userId: string) => {
    const path = `cocineros/${userId}/logo-${Date.now()}.webp`;
    const { error } = await supabase.storage.from('cocineros').upload(path, file, { upsert: true });
    if (error) throw error;
    const { data } = supabase.storage.from('cocineros').getPublicUrl(path);
    return data.publicUrl;
  };

  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;
    setValue('logo', file);
  };

  const onSubmit = async (data: ProducerFormData) => {
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) throw new Error('No autenticado');

    const logo_url = data.logo ? await uploadLogo(data.logo, user.id) : null;

    const { error } = await supabase.from('producers').upsert(
      {
        id: user.id,
        business_name: data.business_name,
        description: data.description,
        address: data.address,
        email: data.email,
        phone: data.phone,
        logo_url,
      },
      { onConflict: 'id' }
    );

    if (error) throw error;
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input type="text" {...register('business_name')} />
      <input type="text" {...register('address')} />
      <input type="email" {...register('email')} />
      <input type="text" {...register('phone')} />
      <textarea {...register('description')} />
      <input type="file" name="logo" onChange={handleLogoChange} />
      <button type="submit">Guardar</button>
    </form>
  );
}
